<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layouts/layout1}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/cart.css}">
    </th:block>
</head>

<body>
    <div layout:fragment="content" class="content">

        <div class="container" style="max-width: 900px;">
            <h2 class="cart-title text-center">장바구니</h2>

            <table class="cart-table">
                <colgroup>
                    <col width="15%" />
                    <col width="40%" />
                    <col width="15%" />
                    <col width="20%" />
                    <col width="10%" />
                </colgroup>
                <thead>
                    <tr class="text-center">
                        <th>상품정보</th>
                        <th></th>
                        <th>수량</th>
                        <th>주문금액</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item : ${cartItems}">
                        <td class="text-center">
                            <a th:href="'/item/' + ${item.cartItemId}">
                                <img th:src="@{|/images/${#strings.toLowerCase(item.itemCategory)}/${item.imgName}|}" 
                                     class="cart-item-img" th:alt="${item.itemNm}" />
                            </a>
                        </td>
                        
                        <td>
                            <span th:text="${item.itemNm}" class="item-name">상품명</span>
                            <span class="text-muted small" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + '원'">가격</span>
                        </td>

                        <td class="text-center">
                            <input type="number" class="quantity-input" 
                                   th:value="${item.count}" min="1"
                                   th:onchange="changeCount(this, [[${item.cartItemId}]])" />
                        </td>

                        <td class="text-center">
                            <span th:text="${#numbers.formatInteger(item.price * item.count, 0, 'COMMA')} + '원'" 
                                  class="fw-bold fs-5"></span>
                        </td>
                        
                        <td class="text-center">
                            <button type="button" class="btn-delete"
                                    th:onclick="'deleteCartItem(' + ${item.cartItemId} + ')'"
                                    title="삭제">
                                ✕
                            </button>
                        </td>
                    </tr>
                    
                    <tr th:if="${#lists.isEmpty(cartItems)}">
                        <td colspan="5" class="text-center py-5">
                            <p class="text-muted my-4">장바구니에 담긴 상품이 없습니다.</p>
                            <a href="/" class="btn btn-primary px-4 rounded-pill">쇼핑하러 가기</a>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="cart-actions" th:unless="${#lists.isEmpty(cartItems)}">
                <a href="/" class="btn btn-outline-secondary">쇼핑 계속하기</a>
                <button type="button" class="btn btn-primary" onclick="orderAll()">주문하기</button>
            </div>
        </div>

        <script>
            function changeCount(input, cartItemId) {
                var count = input.value;
                if (count < 1) {
                    alert("수량은 최소 1개 이상이어야 합니다.");
                    input.value = 1;
                    return;
                }
                fetch('/cart/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'cartItemId=' + cartItemId + '&count=' + count
                })
                .then(response => {
                    if (response.ok) location.reload();
                    else return response.text().then(text => { throw new Error(text) });
                })
                .catch(error => {
                    alert("에러: " + error.message);
                    location.reload();
                });
            }
            
            function deleteCartItem(cartItemId) {
                if (!confirm("선택한 상품을 삭제하시겠습니까?")) return;
                fetch('/cart/item/' + cartItemId, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) location.reload();
                    else return response.text().then(text => { throw new Error(text) });
                })
                .catch(error => {
                    alert("에러: " + error.message);
                });
            }
			function orderAll() {
				if (!confirm("정말 주문하시겠습니까?")) {
				       return; 
				}

			    fetch("/order", { method: "POST" })
			        .then(res => res.text())
			        .then(msg => {
			            if (msg === "success") {
			                alert("구매가 완료되었습니다.");
			                location.href = "/orders";
			            } else {
			                alert(msg);
			                if (msg === "로그인이 필요합니다.") {
			                    location.href = "/login";
			                }
			            }
			        });
			}
        </script>

    </div>
</body>
</html>